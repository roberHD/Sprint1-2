<!DOCTYPE html>
<html>
  <head>
    <title>Mr. Sandwich - Carrito</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <body>
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="inicio.HTML">Mr. Sandwich</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNavDropdown">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="inicio.HTML">Inicio</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="Pedir.HTML">Pedir</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="Carrito.HTML">Carrito</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="Login.HTML" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Login
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                    <li><a class="dropdown-item" href="Login.HTML">Login</a></li>
                                    <li><a class="dropdown-item" href="Mispedidos.HTML">Mis pedidos</a></li>
                                    <li><a class="dropdown-item" href="#">Contacto</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

        <div class="container mt-5">
            <div class="card shadow-sm p-4">
                <div class="row">
                    <!-- Resumen del carrito -->
                    <div class="col-md-12">
                        <h5 class="text-muted">Men√∫</h5>
                        <h2 class="fw-bold mb-4">Resumen del Carrito</h2>
                    </div>

                    <div id="contenedor-carrito"></div>


                    <!-- Opciones de entrega -->
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">M√©todo de entrega:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="entrega" id="retiro" value="retiro" checked>
                            <label class="form-check-label" for="retiro">
                                Retiro en tienda
                            </label>
                            <p class="text-secondary small ms-4">Selecciona tu tienda preferida para retiro en 15 minutos.</p>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="entrega" id="delivery" value="delivery">
                            <label class="form-check-label" for="delivery">
                                Delivery
                            </label>
                            <div class="ms-4 mt-2">
                                <input type="text" class="form-control" placeholder="Direcci√≥n de entrega" style="max-width: 400px;">
                                <p class="text-secondary small">Tiempo estimado: 30-45 minutos. +$2.000 por delivery.</p>
                            </div>
                        </div>
                    </div>

                    
                    <div class="col-md-12 mb-4">
                        <label class="form-label fw-semibold">Medio de pago:</label>
                        <select class="form-select" style="max-width: 300px;">
                            <option selected>Visa D√©bito</option>
                            <option>Visa Cr√©dito</option>
                            <option>Mastercard</option>
                            <option>Efectivo al retiro</option>
                        </select>
                    </div>
                    
                <ul id="lista-carrito" class="list-group mb-3"></ul>
                    <h4 id="total" class="fw-bold text-success mt-3"></h4>
                    <button id="vaciar" class="btn btn-danger">Vaciar carrito</button>

                    <div class="col-md-12">
                        <button type="button" class="btn btn-dark w-100 mb-3" onclick="confirmarPedido()">Confirmar Pedido</button>
                    </div>

                    
                    <div id="mensajeExito" class="col-md-12 d-none text-center mt-4">
                        <div class="alert alert-success">
                            <h5>- Pedido confirmado con √©xito</h5>
                            <p class="mb-0">- N√∫mero de seguimiento: #ORD-20251006-001</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>
        function formatearPrecio(n) {
            return n.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        }

        function renderCarrito() {
            const raw = localStorage.getItem("miCarrito");
            const carrito = raw ? JSON.parse(raw) : [];
            const contenedor = document.getElementById("contenedor-carrito");
            const totalTxt = document.getElementById("total");
            const vaciarBtn = document.getElementById("vaciar");

            contenedor.innerHTML = "";

            if (carrito.length === 0) {
                contenedor.innerHTML = '<p class="text-muted text-center mt-3">El carrito est√° vac√≠o</p>';
                totalTxt.textContent = "";
                return;
            }

            let total = 0;
            carrito.forEach(item => {
                const productoHTML = `
                <div class="col-md-12 mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <img src="img/${item.nombre.replace(/\s+/g, '')}.png" 
                                alt="${item.nombre}" 
                                class="img-fluid rounded" 
                                style="max-width: 100px;">
                            <p class="mt-2 text-muted small">Producto</p>
                        </div>
                        <div class="col-md-10">
                            <h5 class="fw-bold">${item.nombre}</h5>
                            <p class="text-secondary small mb-1">Cantidad: ${item.cantidad}</p>
                            <p class="fs-5 text-success fw-bold">${formatearPrecio(item.precio)}</p>
                        </div>
                    </div>
                </div>`;
                contenedor.insertAdjacentHTML("beforeend", productoHTML);
                total += item.precio * item.cantidad;
            });

            totalTxt.textContent = "Total: " + formatearPrecio(total);
        }

        document.addEventListener("DOMContentLoaded", () => {
            renderCarrito();

            document.getElementById("vaciar").addEventListener("click", () => {
                localStorage.removeItem("miCarrito");
                renderCarrito();
            });
        });
        </script>

        <script>
        async function confirmarPedido() {
            const raw = localStorage.getItem("miCarrito");
            const carrito = raw ? JSON.parse(raw) : [];

            if (carrito.length === 0) {
                alert("üõí El carrito est√° vac√≠o");
                return;
            }

            const metodoEntrega = document.querySelector('input[name="entrega"]:checked').value;
            const metodoPago = document.querySelector("select").value;
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);

            const pedido = { productos: carrito, total, metodoEntrega, metodoPago };

            try {
                const respuesta = await fetch("http://localhost:3000/api/pedidos", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(pedido)
                });

                if (respuesta.ok) {
                    alert("‚úÖ Pedido enviado con √©xito");
                    localStorage.removeItem("miCarrito");
                    renderCarrito();
                } else {
                alert("‚ùå Error al enviar el pedido");
                }
            } catch (error) {
                console.error(error);
                alert("‚ö†Ô∏è No se pudo conectar con el servidor");
            }
        }
        </script>
    </body>
</html>